# Biz Directory API

A RESTful API backend for a business directory and review system based on the Yelp dataset. Built with Python Flask, MongoDB, and JWT authentication.

## Features

- **User Authentication**: JWT-based authentication with secure password hashing
- **Role-Based Access Control**: Three user levels (public, registered user, admin)
- **Business Management**: Full CRUD operations for businesses
- **Review System**: Users can create, read, update, and delete reviews
- **Advanced Search**: Search businesses by name, city, state, category, and rating
- **Pagination**: Efficient data retrieval with pagination support
- **Automatic Rating Calculation**: Business ratings update automatically based on reviews
- **Input Validation**: Comprehensive validation and error handling
- **RESTful Design**: Proper HTTP methods and status codes

## Technologies

- **Backend**: Python 3.11, Flask 3.1.2
- **Database**: MongoDB 
- **Authentication**: Flask-JWT-Extended, Werkzeug (password hashing)
- **API**: Flask-CORS (cross-origin requests)
- **Environment**: python-dotenv

## Database Structure

### Collections

1. **Users**
   - _id (ObjectId)
   - username (string)
   - email (string, unique)
   - password (hashed string)
   - role (string: "user" or "admin")
   - createdAt (datetime)

2. **Businesses**
   - _id (ObjectId)
   - name (string)
   - city (string)
   - state (string)
   - address (string)
   - category (string)
   - phone (string)
   - rating (float, auto-calculated)
   - reviewCount (int, auto-calculated)
   - createdAt (datetime)

3. **Reviews**
   - _id (ObjectId)
   - businessId (ObjectId, reference to Business)
   - userId (ObjectId, reference to User)
   - rating (int, 1-5)
   - text (string)
   - createdAt (datetime)

## Installation & Setup

### 1. Prerequisites

- Python 3.11
- MongoDB

### 2. Install Dependencies

```bash
pip install flask flask-pymongo flask-jwt-extended flask-cors python-dotenv pymongo
```

Or using the requirements generated by the package manager:
```bash
uv sync
```

### 3. Start the Application

```bash
bash start.sh
```

This will:
- Start MongoDB on port 27017
- Start the Flask API on port 5000

### 4. Seed Sample Data (Recommended)

```bash
python seed_data.py
```

This creates:
- Admin user: `admin@bizdirectory.com` / `admin123`
- Regular user: `john@example.com` / `password123`
- 5 sample businesses
- 5 sample reviews

**Important**: Admin users can only be created through:
1. Running the seed script (recommended for testing)
2. Manual database insertion with `role: "admin"`

Regular user registration via the API always creates users with `role: "user"` for security purposes.

## API Endpoints

### Base URL
```
http://localhost:5000
```

### Authentication Endpoints

#### Register User
```
POST /api/auth/register
Content-Type: application/json

{
  "username": "john_doe",
  "email": "john@example.com",
  "password": "password123"
}
```

**Note**: All new registrations are automatically assigned the "user" role for security. Admin users must be created via the seed script or manual database update.

#### Login
```
POST /api/auth/login
Content-Type: application/json

{
  "email": "john@example.com",
  "password": "password123"
}

Response:
{
  "message": "Login successful",
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbG...",
  "user": {...}
}
```

#### Get Current User
```
GET /api/auth/me
Authorization: Bearer <token>
```

### Business Endpoints

#### Get All Businesses (with pagination)
```
GET /api/businesses?page=1&limit=20&rating=4.0
```

#### Search Businesses
```
GET /api/businesses/search?name=coffee&city=New%20York&category=Coffee&rating=4
```

Query Parameters:
- `name` - Search by business name (case-insensitive)
- `city` - Filter by city (case-insensitive)
- `state` - Filter by state (case-insensitive)
- `category` - Filter by category (case-insensitive)
- `rating` - Minimum rating (float)
- `page` - Page number (default: 1)
- `limit` - Items per page (default: 20)

#### Get Single Business
```
GET /api/businesses/<business_id>
```

#### Create Business (requires authentication)
```
POST /api/businesses
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Joe's Coffee",
  "city": "New York",
  "state": "NY",
  "address": "123 Main St",
  "category": "Coffee Shop",
  "phone": "555-0123"
}
```

#### Update Business (admin only)
```
PUT /api/businesses/<business_id>
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Joe's Premium Coffee",
  "phone": "555-0124"
}
```

#### Delete Business (admin only)
```
DELETE /api/businesses/<business_id>
Authorization: Bearer <token>
```

### Review Endpoints

#### Get Reviews for a Business
```
GET /api/businesses/<business_id>/reviews?page=1&limit=20
```

#### Create Review (requires authentication)
```
POST /api/businesses/<business_id>/reviews
Authorization: Bearer <token>
Content-Type: application/json

{
  "rating": 5,
  "text": "Amazing coffee! Best in the city."
}
```

#### Get Single Review
```
GET /api/reviews/<review_id>
```

#### Update Review (owner or admin)
```
PUT /api/reviews/<review_id>
Authorization: Bearer <token>
Content-Type: application/json

{
  "rating": 4,
  "text": "Updated review text"
}
```

#### Delete Review (owner or admin)
```
DELETE /api/reviews/<review_id>
Authorization: Bearer <token>
```

## Access Control

### Public Users (No Authentication)
- View all businesses
- Search businesses
- View all reviews

### Registered Users (Authenticated)
- All public permissions
- Create businesses
- Create reviews
- Edit their own reviews
- Delete their own reviews

### Admin Users
- All registered user permissions
- Edit any business
- Delete any business
- Delete any review

## HTTP Status Codes

- `200 OK` - Successful GET, PUT, DELETE
- `201 Created` - Successful POST
- `400 Bad Request` - Invalid input or validation error
- `401 Unauthorized` - Missing or invalid authentication token
- `403 Forbidden` - Insufficient permissions
- `404 Not Found` - Resource not found
- `409 Conflict` - Duplicate resource (e.g., email already exists)
- `500 Internal Server Error` - Server error

## Error Response Format

```json
{
  "error": "Descriptive error message"
}
```

## Success Response Format

```json
{
  "message": "Operation successful",
  "data": {...}
}
```

## Project Structure

```
.
├── app.py                 # Main Flask application
├── config.py             # Configuration settings
├── routes/
│   ├── auth.py          # Authentication endpoints
│   ├── businesses.py    # Business CRUD endpoints
│   └── reviews.py       # Review CRUD endpoints
├── utils/
│   ├── decorators.py    # Custom decorators (admin_required, etc.)
│   └── helpers.py       # Helper functions
├── start.sh             # Startup script
├── seed_data.py         # Sample data seeder
└── README.md            # This file
```

## Testing with Postman

1. Import the API endpoints into Postman
2. Create an environment with:
   - `base_url`: `http://localhost:5000`
   - `token`: (set after login)

3. Test Flow:
   - Register a user
   - Login and save the access token
   - Create a business
   - Add a review
   - Search businesses
   - Update/delete as admin

## Data Export

To export MongoDB collections (for submission):

```bash
mongoexport --db=biz_directory --collection=users --out=users.json
mongoexport --db=biz_directory --collection=businesses --out=businesses.json
mongoexport --db=biz_directory --collection=reviews --out=reviews.json
```

## Security Features

- Passwords are hashed using Werkzeug's secure hash algorithm
- JWT tokens for stateless authentication
- Role-based access control
- Input validation on all endpoints
- Environment variables for sensitive configuration

## Future Enhancements

- User profile management
- Business owner claims
- Photo uploads for businesses
- Review voting (helpful/not helpful)
- Advanced filtering and sorting
- Geolocation search
- Email verification
- Password reset functionality

## License

This is an academic project for COM661 Full Stack Strategies and Development.

## Author

Created as part of the COM661 assignment.
